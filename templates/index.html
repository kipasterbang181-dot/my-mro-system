<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="G7 Aerospace Authorized Maintenance Log System">
    
    <title>G7 Aerospace | Service Log & Data Entry</title>
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a;
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%231e3a8a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em;
        }

        .lang-btn {
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .lang-btn.active {
            background-color: #1e3a8a;
            color: #ffffff;
            border-color: #1e3a8a;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .progress-wrapper {
            transition: all 0.3s ease-in-out;
        }
        
        #progressBar {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
    </style>
</head>

<body class="min-h-screen p-4 flex flex-col items-center justify-center">

    <div class="fixed top-6 right-6 flex gap-2 bg-white/10 p-1 rounded-full backdrop-blur-md border border-white/20 z-50 shadow-xl">
        <button onclick="changeLanguage('ms')" id="btn-ms" class="lang-btn px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest cursor-pointer text-slate-400">
            Melayu
        </button>
        <button onclick="changeLanguage('en')" id="btn-en" class="lang-btn px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest cursor-pointer text-slate-400">
            English
        </button>
    </div>

    <div class="max-w-2xl w-full bg-white p-10 rounded-[3rem] shadow-2xl border-t-8 border-blue-900 relative my-10">
        
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black text-blue-900 uppercase italic leading-none tracking-tighter hover:scale-105 transition-transform cursor-default">
                G7 <span class="text-slate-400">Aerospace</span>
            </h1>
            <p id="t-subtitle" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] mt-3 border-b border-slate-100 pb-4 inline-block">
                Authorized Maintenance Log
            </p>
        </div>

        <form action="/incoming" method="POST" id="mainForm" class="space-y-6">
            
            <div class="form-group">
                <label id="t-label-equip" for="p-equip" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                    Name Equipment
                </label>
                <input type="text" name="peralatan" id="p-equip" placeholder="ENTER EQUIPMENT TYPE" 
                    class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-slate-800 uppercase focus:border-blue-900 outline-none transition-all shadow-sm placeholder-slate-300" 
                    required autocomplete="off">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <div class="form-group">
                    <label id="t-label-pn" for="p-pn" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                        Part Number (P/N)
                    </label>
                    <input type="text" name="pn" id="p-pn" placeholder="ENTER P/N" 
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-slate-700 uppercase focus:border-blue-900 outline-none transition-all shadow-sm placeholder-slate-300" 
                        required>
                </div>

                <div class="form-group">
                    <label id="t-label-sn" for="p-sn" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                        Serial Number (S/N)
                    </label>
                    <input type="text" name="sn" id="p-sn" placeholder="ENTER S/N" 
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-mono font-black text-blue-600 uppercase focus:border-blue-900 outline-none transition-all shadow-sm placeholder-slate-300" 
                        required>
                </div>
            </div>

            <div class="form-group">
                <label id="t-label-defect" for="p-defect" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                    Defect / Remarks
                </label>
                <textarea name="defect" id="p-defect" placeholder="DESCRIBE THE DEFECT" rows="2"
                    class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-slate-700 uppercase focus:border-blue-900 outline-none transition-all shadow-sm placeholder-slate-300 resize-none"></textarea>
            </div>

            <div class="form-group">
                <label id="t-label-pic" for="p-pic" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                    PIC / Remarks
                </label>
                <input type="text" name="pic" id="p-pic" placeholder="ENTER PIC OR REMARKS" 
                    class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold text-slate-700 uppercase focus:border-blue-900 outline-none transition-all shadow-sm placeholder-slate-300">
            </div>

            <div class="form-group">
                <label id="t-label-status" for="s-status" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-1 block tracking-widest">
                    Authorization Status
                </label>
                <div class="relative">
                    <select name="status" id="s-status" 
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-black text-slate-700 uppercase focus:border-blue-900 outline-none transition-all shadow-sm cursor-pointer" 
                        required>
                        <option value="" id="t-opt-status" disabled selected>CHOOSE STATUS</option>
                        <option value="SERVICEABLE">SERVICEABLE</option>
                        <option value="READY TO QUOTE">READY TO QUOTE</option>
                        <option value="READY TO DELIVERED">READY TO DELIVERED</option>
                        <option value="RETURN TO AEROTREE">RETURN TO AEROTREE</option>
                        <option value="WARRANTY REPAIR">WARRANTY REPAIR</option>
                        <option value="TDI ON PROGRESS">TDI ON PROGRESS</option>
                        <option value="OV TDI">OV TDI</option>
                        <option value="UNDER REPAIR">UNDER REPAIR</option>
                    </select>
                </div>
            </div>

            <input type="hidden" name="drn" value="-">
            <input type="hidden" name="date_in" id="current_date" value="">

            <div class="flex flex-col gap-4 pt-4 border-t border-slate-50 mt-6">
                <button type="submit" id="t-btn-save" 
                    class="w-full bg-blue-900 text-white font-black py-6 rounded-[2rem] hover:bg-black hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 shadow-xl uppercase tracking-widest text-sm italic relative overflow-hidden group">
                    <span class="relative z-10">Confirm & Save Log</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-800 to-indigo-900 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button>
                
                <a href="/login" id="t-btn-admin" 
                    class="w-full bg-slate-100 text-slate-500 text-center font-black py-4 rounded-[2rem] hover:bg-slate-200 hover:text-slate-800 transition-all uppercase tracking-[0.3em] text-[10px] no-underline border border-transparent hover:border-slate-300">
                    Admin Access Portal
                </a>
            </div>
        </form>

        <div class="mt-12 pt-10 border-t-2 border-slate-50 relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-white px-4 text-slate-300 text-[10px] font-black uppercase tracking-widest">
                OR
            </div>

            <label id="t-label-bulk" class="text-[10px] font-black uppercase text-blue-900/40 ml-4 mb-3 block tracking-widest">
                Bulk Import (Excel / CSV)
            </label>
            
            <div class="relative group">
                <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="hidden">
                <label for="excelInput" 
                    class="w-full flex items-center justify-between p-5 bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:border-blue-900 hover:bg-blue-50/30 transition-all group duration-300">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-200 p-2 rounded-lg text-slate-500 group-hover:bg-blue-200 group-hover:text-blue-800 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        </div>
                        <span id="fileName" class="text-xs font-bold text-slate-400 uppercase truncate max-w-[200px] sm:max-w-xs">
                            Pilih fail Excel...
                        </span>
                    </div>
                    <span id="t-btn-browse" class="bg-slate-200 text-slate-600 text-[10px] font-black px-4 py-2 rounded-xl uppercase group-hover:bg-blue-900 group-hover:text-white transition-colors shadow-sm">
                        Browse
                    </span>
                </label>
            </div>

            <div id="progressContainer" class="mt-6 hidden transition-all">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Uploading Status</span>
                    <span id="percentageText" class="text-[9px] font-black text-emerald-600">0%</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden border border-slate-200">
                    <div id="progressBar" class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full w-0 transition-all duration-300 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                </div>
                <p id="progressText" class="text-[10px] font-black text-emerald-600 uppercase mt-2 text-center tracking-widest">
                    Sedia untuk import...
                </p>
            </div>

            <button onclick="uploadExcel()" id="uploadBtn" 
                class="w-full mt-4 bg-emerald-600 text-white font-black py-4 rounded-[2rem] hover:bg-black hover:shadow-lg transition-all shadow-md uppercase tracking-widest text-[10px] hidden flex items-center justify-center gap-2 transform active:scale-95">
                <span>ðŸš€</span> <span id="t-btn-import">Start Import Data</span>
            </button>
        </div>

        <div class="mt-12 text-center border-t border-slate-50 pt-6">
            <p class="text-[8px] font-bold text-slate-300 uppercase tracking-widest hover:text-blue-300 transition-colors cursor-default">
                Â© 2024-2026 G7 Aerospace Digital System v4.5
            </p>
        </div>
    </div>

    <script>
        // Auto Date Generator
        document.getElementById('mainForm').addEventListener('submit', function() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('current_date').value = `${year}-${month}-${day}`;
        });

        // Language Dictionary
        const dictionary = {
            ms: {
                subtitle: "Log Penyelenggaraan Sah",
                labelEquip: "Nama Peralatan",
                phEquip: "MASUKKAN JENIS PERALATAN",
                labelPn: "Nombor Bahagian (P/N)",
                phPn: "MASUKKAN P/N",
                labelSn: "Nombor Siri (S/N)",
                phSn: "MASUKKAN S/N",
                labelDefect: "Kerosakan / Catatan",
                phDefect: "JELASKAN KEROSAKAN",
                labelPic: "PIC / Catatan",
                phPic: "MASUKKAN PIC ATAU CATATAN",
                labelStatus: "Status Kebenaran",
                optStatus: "PILIH STATUS",
                btnSave: "Sahkan & Simpan Log",
                btnAdmin: "Portal Akses Admin",
                labelBulk: "Import Pukal (Excel)",
                phFile: "Pilih fail Excel...",
                btnBrowse: "Cari",
                btnImport: "Mulakan Import Data",
                textReady: "Sedia untuk import...",
                textImporting: "SEDANG IMPORT"
            },
            en: {
                subtitle: "Authorized Maintenance Log",
                labelEquip: "Name Equipment",
                phEquip: "ENTER EQUIPMENT TYPE",
                labelPn: "Part Number (P/N)",
                phPn: "ENTER P/N",
                labelSn: "Serial Number (S/N)",
                phSn: "ENTER S/N",
                labelDefect: "Defect / Remarks",
                phDefect: "DESCRIBE THE DEFECT",
                labelPic: "PIC / Remarks",
                phPic: "ENTER PIC OR REMARKS",
                labelStatus: "Authorization Status",
                optStatus: "CHOOSE STATUS",
                btnSave: "Confirm & Save Log",
                btnAdmin: "Admin Access Portal",
                labelBulk: "Bulk Import (Excel)",
                phFile: "Choose Excel file...",
                btnBrowse: "Browse",
                btnImport: "Start Import Data",
                textReady: "Ready to import...",
                textImporting: "IMPORTING"
            }
        };

        function changeLanguage(lang) {
            localStorage.setItem('g7_lang', lang);
            const t = dictionary[lang];

            const elements = {
                't-subtitle': t.subtitle,
                't-label-equip': t.labelEquip,
                't-label-pn': t.labelPn,
                't-label-sn': t.labelSn,
                't-label-defect': t.labelDefect,
                't-label-pic': t.labelPic,
                't-label-status': t.labelStatus,
                't-opt-status': t.optStatus,
                't-btn-save': t.btnSave,
                't-btn-admin': t.btnAdmin,
                't-label-bulk': t.labelBulk,
                'fileName': t.phFile,
                't-btn-browse': t.btnBrowse,
                't-btn-import': t.btnImport,
                'progressText': t.textReady
            };

            for (const [id, text] of Object.entries(elements)) {
                const el = document.getElementById(id);
                if (el) el.innerText = text;
            }

            document.getElementById('p-equip').placeholder = t.phEquip;
            document.getElementById('p-pn').placeholder = t.phPn;
            document.getElementById('p-sn').placeholder = t.phSn;
            document.getElementById('p-defect').placeholder = t.phDefect;
            document.getElementById('p-pic').placeholder = t.phPic;

            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
        }

        const savedLang = localStorage.getItem('g7_lang') || 'ms';
        changeLanguage(savedLang);

        // Excel File Handler
        const excelInput = document.getElementById('excelInput');
        const fileNameDisplay = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const percentageText = document.getElementById('percentageText');

        excelInput.addEventListener('change', function(e) {
            if(e.target.files.length > 0) {
                const fName = e.target.files[0].name;
                fileNameDisplay.innerText = fName;
                fileNameDisplay.classList.remove('text-slate-400');
                fileNameDisplay.classList.add('text-blue-900');
                
                uploadBtn.classList.remove('hidden');
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }
        });

        // Date Parser
        function parseExcelDate(val) {
            if (!val || val === "0" || val === "" || val === 0 || String(val).toUpperCase() === "N/A" || val === "-") return "";
            
            let date;
            
            if (typeof val === 'number') {
                date = new Date(Math.round((val - 25569) * 86400 * 1000));
            } 
            else if (val instanceof Date) {
                date = val;
            } 
            else {
                let str = String(val).trim();
                let parts = str.split(/[-/]/);
                if (parts.length === 3) {
                    let d = parts[0].padStart(2, '0');
                    let m = parts[1].padStart(2, '0');
                    let y = parts[2];
                    if (y.length === 2) y = "20" + y;
                    date = new Date(`${y}-${m}-${d}`);
                } else {
                    date = new Date(str);
                }
            }

            if (date && !isNaN(date.getTime())) {
                let year = date.getFullYear();
                let month = String(date.getMonth() + 1).padStart(2, '0');
                let day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return ""; 
        }

        // âœ… FIXED: Excel Upload â€” auto header + separate JTP & REMARKS â†’ PIC
        function uploadExcel() {
            const file = excelInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawRows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ""});

                    // â”€â”€â”€ 1. AUTO-DETECT header row â”€â”€â”€
                    let headerIndex = -1;
                    const keywords = ['part no', 'serial no', 'description', 'date in', 'status'];
                    for (let i = 0; i < Math.min(15, rawRows.length); i++) {
                        const rowLower = rawRows[i].map(c => String(c || '').toLowerCase());
                        const hits = keywords.filter(kw => rowLower.includes(kw)).length;
                        if (hits >= 3) { headerIndex = i; break; }
                    }
                    if (headerIndex === -1) headerIndex = 0;
                    const headerRow = rawRows[headerIndex];
                    console.log('ðŸ“‹ Header at row', headerIndex, 'â†’', headerRow);

                    // â”€â”€â”€ 2. MAP columns by exact header name â”€â”€â”€
                    const colMap = {};
                    headerRow.forEach((h, idx) => {
                        const key = String(h || '').toLowerCase().trim();
                        if (key === 'part no')          colMap.pn      = idx;
                        else if (key === 'description') colMap.desc    = idx;
                        else if (key === 'serial no')   colMap.sn      = idx;
                        else if (key === 'date in')     colMap.dateIn  = idx;
                        else if (key === 'date out')    colMap.dateOut = idx;
                        else if (key === 'status')      colMap.status  = idx;
                        else if (key === 'jtp')         colMap.jtp     = idx;     // JTP separate
                        else if (key === 'remarks')     colMap.remarks = idx;     // REMARKS separate
                        else if (key === 'defect')      colMap.defect  = idx;     // DEFECT only
                    });
                    colMap.pn      = colMap.pn      ?? 1;
                    colMap.desc    = colMap.desc    ?? 2;
                    colMap.sn      = colMap.sn      ?? 3;
                    colMap.dateIn  = colMap.dateIn  ?? 4;
                    colMap.dateOut = colMap.dateOut  ?? 5;
                    colMap.status  = colMap.status  ?? 6;
                    // jtp / remarks / defect â†’ NO hardcoded fallback
                    console.log('ðŸ“Š colMap:', colMap);

                    // â”€â”€â”€ 3. PROCESS each data row â”€â”€â”€
                    const dataRows = rawRows.slice(headerIndex + 1);
                    const formattedData = dataRows.map((row, idx) => {
                        const pn = String(row[colMap.pn] || '').trim().toUpperCase();
                        const sn = String(row[colMap.sn] || '').trim().toUpperCase();

                        // skip empty / sub-header rows (e.g. 2022 has "DATE OUT","DATE IN","VENDOR" row)
                        if (!pn && !sn)                                          return null;
                        if (pn === 'PART NO' || sn === 'SERIAL NO')             return null;
                        if (pn === 'DATE OUT' || pn === 'DATE IN' || pn === 'VENDOR') return null;
                        if (pn === '' || sn === '')                              return null;

                        // PIC = JTP + REMARKS combined (whichever has value)
                        const jtpVal     = (colMap.jtp     !== undefined) ? String(row[colMap.jtp]     || '').trim() : '';
                        const remarksVal = (colMap.remarks !== undefined) ? String(row[colMap.remarks] || '').trim() : '';
                        const picParts   = [jtpVal, remarksVal].filter(v => v && v.toLowerCase() !== 'nan');
                        const picFinal   = picParts.join(' ').trim() || 'N/A';

                        // DEFECT
                        const rawDef   = (colMap.defect !== undefined) ? String(row[colMap.defect] || '').trim() : '';
                        const defFinal = (rawDef && rawDef.toLowerCase() !== 'nan') ? rawDef : 'N/A';

                        if (idx < 3) console.log(`Row ${idx+1}: PIC="${picFinal}" DEFECT="${defFinal}"`);

                        return {
                            "DRN": "-",
                            "PERALATAN": String(row[colMap.desc]  || 'N/A').trim().toUpperCase(),
                            "P/N":       pn,
                            "S/N":       sn,
                            "DATE IN":   parseExcelDate(row[colMap.dateIn]),
                            "DATE OUT":  parseExcelDate(row[colMap.dateOut]),
                            "STATUS":    String(row[colMap.status] || 'UNDER REPAIR').trim().toUpperCase(),
                            "PIC":       picFinal.toUpperCase(),
                            "DEFECT":    defFinal.toUpperCase()
                        };
                    }).filter(item => item !== null);

                    console.log(`ðŸ“¦ Valid rows: ${formattedData.length}`);
                    if (formattedData.length > 0) {
                        processImport(formattedData);
                    } else {
                        alert("No valid data found in this file.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("System Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Process Import with Progress
        async function processImport(dataList) {
            uploadBtn.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            
            const lang = localStorage.getItem('g7_lang') || 'ms';

            // Send as JSON to /import_bulk endpoint
            try {
                const response = await fetch('/import_bulk', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: dataList })
                });

                // Simulate progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    if (progress <= 90) {
                        progressBar.style.width = progress + "%";
                        percentageText.innerText = progress + "%";
                        progressText.innerText = `${dictionary[lang].textImporting}... (${progress}%)`;
                    }
                }, 200);

                const result = await response.json();
                
                clearInterval(interval);
                progressBar.style.width = "100%";
                percentageText.innerText = "100%";

                if (result.status === 'success') {
                    alert(`Import Complete! ${result.count} records saved successfully.`);
                    window.location.reload();
                } else {
                    alert('Import failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
                console.error(error);
            }
        }
    </script>
</body>
</html>
